<script>
  if (!sessionStorage.ID_USUARIO) {
      alert("Você precisa estar logado!");
      window.location.href = '/login/index.html'; 
  }

  var sessaoNome = sessionStorage.NOME_USUARIO || 'Usuário';
  var sessaoSkin = sessionStorage.SRC_SKIN || '/person.png';
  var sessaoNivel = Number(sessionStorage.NIVEL_DINO) || 1;
  var sessaoXP = Number(sessionStorage.XP) || 0; 
  var sessaoFome = Number(sessionStorage.FOME) || 100;
  var sessaoEnergia = Number(sessionStorage.ENERGIA) || 100;

  var xpState = [sessaoXP, sessaoNivel]; 
  var dia = true;
  var petTam = 150;
  
  var statusData = [
    [sessaoFome, 1500, innercircle_hungry], 
    [100, 2500, innercircle_happy],         
    [sessaoEnergia, 2500, innercircle_sleep] 
  ];


  var overlay = div_overlay;
  var videoNoite = bg_video;
  var petId = document.getElementById('pet');
  var xpFillEl = document.getElementById('xpFill');
  var xpPercentEl = document.getElementById('xpPercent');
  var xpWrapEl = document.getElementById('xpWrap');
  var levelBadgeEl = document.getElementById('level-badge');
  
  var xpHideTimer = null;
  var isAnimating = false;
  var fps = 12;

  var positionStatus = [-90, -10];
  
  var framesSentar = [
    '/sprints/sit/frame_1.png', '/sprints/sit/frame_2.png', '/sprints/sit/frame_3.png',
    '/sprints/sit/frame_6.png', '/sprints/sit/frame_7.png', '/sprints/sit/frame_8.png',
    '/sprints/sit/frame_9.png', '/sprints/sit/frame_10.png', '/sprints/sit/frame_11.png',
    '/sprints/sit/frame_13.png'
  ];

  var feeling = [
    [128526, 'estilo'], [128512, 'feliz'], [128544, 'bravo'],
    [128546, 'triste'], [128533, 'confuso']
  ];


  function carregarDadosUsuario() {
      var elNome = document.querySelector('.profile-name');
      elNome.innerText = sessaoNome;

      petId.src = sessaoSkin;

      innerText = 'Lv. ' + sessaoNivel;
      renderXP(false);
      calcularStatus(0); 
      calcularStatus(1); 
      calcularStatus(2); 
  }


  function startNightTransition() {
    if (dia) {
      text_transition.innerHTML = `Então anoiteceu...`;
    } else {
      text_transition.innerHTML = `Então amanheceu...`;
    }

    overlay.classList.add('active');
    setTimeout(() => {
      overlay.classList.remove('active');
      overlay.classList.add('fade-out');
      setTimeout(() => {
        overlay.classList.remove('fade-out');
      }, 7500);
    }, 6000);
  }

  function virarNoite() {
    if (dia) {
      startNightTransition();
      setTimeout(() => {
        videoNoite.style.display = "block";
        document.body.style.backgroundImage = "none";
        setTimeout(() => {
          videoNoite.style.opacity = "0";
          videoNoite.style.display = "none";
          document.body.style.backgroundImage = "url(/backgound/noite.png)";
        }, 8000);
      }, 5000);
      dia = false;
    } else {
      startNightTransition();
      setTimeout(() => {
        videoNoite.style.opacity = "0";
        videoNoite.style.display = "none";
        document.body.style.backgroundImage = "url(/backgound/dia2.png)";
      }, 5000);
      dia = true;
    }
  }

  function aumentarPet() {
    if (petTam <= 600) {
      petId.style.width = `${petTam + 50}px`;
      petTam += 100;
    }
  }

  function sentar() {
    if (petId.src.includes(framesSentar[framesSentar.length - 1])) {
      isAnimating = true;
      var i = framesSentar.length - 1;

      var intervaloLevantar = setInterval(() => {
        petId.src = framesSentar[i];
        i--;

        if (i <= 0) {
          clearInterval(intervaloLevantar);
          isAnimating = false;
          petId.src = framesSentar[0];
        }
      }, 1000 / fps);

      levantar.innerHTML = `Sentar`;
    } else {
      isAnimating = true;
      var i = 0;

      var intervaloSentar = setInterval(() => {
        petId.src = framesSentar[i];
        i++;

        if (i >= framesSentar.length) {
          clearInterval(intervaloSentar);
          isAnimating = false;
          petId.src = framesSentar[framesSentar.length - 1];
        }
      }, 1000 / fps);
      levantar.innerHTML = `Levantar`;
    }
  }

  function alimentar() {
    if(statusData[0][0] < 100) {
        statusData[0][0] += 20;
        if(statusData[0][0] > 100) statusData[0][0] = 100;
        calcularStatus(0);
        adicionarXP(18);
    }
  }

  function dormir() {
    if(statusData[2][0] < 100) {
        statusData[2][0] += 1;
        if(statusData[2][0] > 100) statusData[2][0] = 100;
        calcularStatus(2);
    }
  }

  function calcularStatus(iStatus) {
    var rangePX = positionStatus[0] - positionStatus[1];
    var statusPX = (rangePX * statusData[iStatus][0]) / 100;

    if (statusPX <= positionStatus[1]) {
      statusData[iStatus][2].style.top = `${statusPX}px`;
    } else {
      statusData[iStatus][2].style.top = `${positionStatus[1]}px`;
    }
  }

  function diminuirStatus(iStatus) {
    if (dia) {
      statusData[iStatus][0] -= 5;
      if(statusData[iStatus][0] < 0) statusData[iStatus][0] = 0;
      calcularStatus(iStatus);
    } else {
      dormir();
    }
  }

  function intervalStatus(iStatus) {
    setInterval(() => diminuirStatus(iStatus), statusData[iStatus][1]);
  }

  function renderStatus() {
    for (var i = 0; i < statusData.length; i++) {
      intervalStatus(i);
    }
  }

  function renderXP() {
    var xp = xpState[0];
    xpFillEl.style.width = xp + '%';
    xpPercentEl.textContent = xp + '%';
  }

  function mostrarXP(tempo) {
    xpWrapEl.classList.add('visible');

    xpHideTimer = setTimeout(function () {
      xpWrapEl.classList.remove('visible');
      xpHideTimer = null;
    }, tempo);
  }

  function pulsoLevel() {
    levelBadgeEl.classList.add('level-badge-pop');
    setTimeout(function () {
      levelBadgeEl.classList.remove('level-badge-pop');
    }, 750);
  }

  function adicionarXP(valor) {
    var antes = xpState[0];
    xpState[0] += valor;

    var up = false;
    while (xpState[0] >= 100) {
      xpWrapEl.classList.add('max');
      xpState[1] = xpState[1] + 1;
      xpState[0] = xpState[0] - 100;
      up = true;
    }

    renderXP();

    if (xpState[0] > antes) {
      mostrarXP(2800);
    }

    if (up) {
      if (levelBadgeEl) levelBadgeEl.textContent = 'Lv. ' + xpState[1];
      aumentarPet();
      pulsoLevel();
    }

    return [up, xpState[0], xpState[1]];
  }

  
  function toggleRadialMenu() {
    var menu = radialMenu;
    menu.classList.toggle('active');
  }

  function handleExpandAction() {
    if (actions.classList.contains('expand')) {
      actions.classList.remove("expand");
    } else {
      actions.classList.add("expand");
    }
  }

  function conversar() {
    if (model.classList.contains('activate')) {
      model.classList.remove('active');
    } else {
      var textEmogi = '';
      for (var i = 0; i < feeling.length; i++) {
        textEmogi += `<button onclick='explainFeeling(${i})' class='emogi-button'>&#${feeling[i][0]}<button>`;
      }
      emogis_container.innerHTML = textEmogi;
      model.classList.add('activate');
    }
  }

  function explainFeeling(indiceEmogi) {
    model.innerHTML = `
      <h2>Caso quiser explique o que sente <h2/>
      <input type='text' id='ipt_textFeeling' oninput="handleTextFeeling()" class='ipt-fell'>
    `;
  }

  function handleTextFeeling() {
    var textFeeling = ipt_textFeeling.value;
  }

  // INICIALIZAÇÃO
  carregarDadosUsuario(); 
  renderStatus(); 
</script>